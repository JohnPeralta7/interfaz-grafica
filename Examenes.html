<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Exámenes Médicos</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Lato', sans-serif;
            background: linear-gradient(to bottom right, #ffffff, #9aeeb2); 
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #1a202c; 
            font-size: 1rem; 
        }
        
        .full-width-container {
            max-width: none; 
            width: 96%; 
            margin-left: auto;
            margin-right: auto;
            padding: 2rem; 
            flex-grow: 1; 
        }

        .main-title-highlight {
            color: #9aeeb2; 
        }

        .text-custom-highlight {
            color: #9aeeb2; 
        }

        .btn-add-item {
            background-color: #9aeeb2;
            color: #1a202c; 
            font-weight: 700;
        }
        .btn-add-item:hover {
            background-color: #7ddc99; 
            transform: scale(1.05);
        }

        .btn-action-icon {
            color: #9aeeb2;
        }
        .btn-action-icon:hover {
            color: #7ddc99; 
            transform: scale(1.15);
        }

        input[type="text"],
        input[type="date"],
        textarea {
            color: #1f2937; 
            font-size: 1rem; 
        }

        .table-cell-text {
            font-size: 1rem; 
            padding-top: 0.75rem; 
            padding-bottom: 0.75rem; 
            vertical-align: top; 
        }

        input[type="text"]::-webkit-calendar-picker-indicator {
            display: none !important;
            -webkit-appearance: none !important;
            opacity: 0 !important;
            pointer-events: none !important;
            position: absolute !important;
            right: 0 !important;
            width: 1px !important;
        }
        input[type="text"]::-moz-calendar-picker-indicator {
            display: none !important;
            -moz-appearance: none !important;
        }
        input[type="text"]::-ms-expand {
            display: none !important;
        }

        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="date"]::-moz-calendar-picker-indicator,
        input[type="date"]::-ms-expand {
            display: initial !important;
            -webkit-appearance: auto !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            position: static !important;
            width: auto !important;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 700px; 
            position: relative;
            animation: fadeIn 0.3s ease-out;
            max-height: 90vh; 
            overflow-y: auto; 
        }

        #detailModal {
            display: none;
            position: fixed;
            z-index: 1001; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5); 
            justify-content: center;
            align-items: center;
        }
        #detailModal .modal-content {
            max-width: 500px;
            padding: 25px;
            text-align: center;
        }
        #detailModal .close-button {
            top: 10px;
            right: 15px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }

        .accordion-header {
            background-color: #f0f0f0;
            color: #1a202c; 
            cursor: pointer;
            padding: 15px 20px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1.125rem; 
            font-weight: 600; 
            transition: background-color 0.3s ease;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px; 
        }

        .accordion-header:hover {
            background-color: #e0e0e0;
        }

        .accordion-header.active {
            background-color: #d1d5db; 
        }

        .accordion-content {
            padding: 0 18px;
            background-color: white;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 6px 6px;
            margin-bottom: 15px;
        }

        .accordion-content.open {
            max-height: 700px; 
            padding: 15px 18px;
            border-radius: 6px; 
        }
        
        .accordion-icon {
            transition: transform 0.3s ease;
        }
        .accordion-header.active .accordion-icon {
            transform: rotate(90deg); 
        }

        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 1.5rem; 
        }
        .pagination-button {
            background-color: #e5e7eb; 
            color: #4b5563; 
            font-weight: 600; 
            padding: 0.5rem 1rem; 
            border-radius: 0.5rem; 
            transition: all 0.2s ease-in-out;
            margin: 0 0.25rem; 
            font-size: 1rem; 
        }
        .pagination-button:hover:not(:disabled) {
            background-color: #d1d5db; 
            transform: scale(1.05);
        }
        .pagination-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-button.active-page {
            background-color: #9aeeb2; 
            color: #1a202c; 
        }
        .pagination-button.active-page:hover {
            background-color: #7ddc99; 
        }

        .pagination-info {
            margin: 0 1rem; 
            font-size: 1rem; 
            color: #4b5563; 
        }
        table thead th {
            font-size: 1rem; 
        }
        .btn-add-item {
            font-size: 1rem; 
        }
        #searchInput, #filterDateInput {
            font-size: 1rem; 
        }
        #sortDateAscBtn, #sortDateDescBtn, #sortPatientAscBtn, #sortPatientDescBtn {
            font-size: 1rem; 
        }
        #modalTitle, #detailModal h3 {
            font-size: 1.5rem; 
        }
        .modal-content label, .modal-content p, #detailContentDisplay, #detailPatientName {
            font-size: 0.9375rem; 
        }
        .btn-action-icon .fa-solid {
            font-size: 1.125rem; 
        }
        h1 {
            font-size: 2rem; 
        }
    </style>
</head>
<body class="p-8">

    <div class="full-width-container bg-white rounded-lg shadow-xl border border-gray-200">
        <h1 class="text-3xl font-bold text-center main-title-highlight mb-8">Gestión de Exámenes Médicos</h1>

        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
            <button id="openModalBtn" class="py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 flex items-center text-lg btn-add-item">
                <i class="fa-solid fa-plus-circle mr-2"></i>
                Añadir Nuevo Examen
            </button>

            <div class="flex flex-wrap items-center gap-4 flex-grow justify-end">
                <div class="relative w-full md:w-auto flex-grow md:flex-grow-0">
                    <input type="text" id="searchInput" placeholder="Buscar por texto..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-50 w-full text-lg">
                    <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-base"></i>
                </div>
                <div class="relative w-full md:w-auto flex-grow md:flex-grow-0">
                    <input type="date" id="filterDateInput" class="py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-50 w-full text-lg">
                </div>
            </div>
            
            <div class="flex flex-wrap gap-2 mt-4 md:mt-0 w-full md:w-auto justify-end">
                <button id="sortDateAscBtn" class="flex-grow md:flex-grow-0 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-3 rounded-lg text-lg transition duration-200 ease-in-out">
                    Fecha (Antiguo <i class="fa-solid fa-arrow-up"></i>)
                </button>
                <button id="sortDateDescBtn" class="flex-grow md:flex-grow-0 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-3 rounded-lg text-lg transition duration-200 ease-in-out">
                    Fecha (Reciente <i class="fa-solid fa-arrow-down"></i>)
                </button>
                <button id="sortPatientAscBtn" class="flex-grow md:flex-grow-0 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-3 rounded-lg text-lg transition duration-200 ease-in-out">
                    Paciente (A <i class="fa-solid fa-arrow-up"></i> Z)
                </button>
                <button id="sortPatientDescBtn" class="flex-grow md:flex-grow-0 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-3 rounded-lg text-lg transition duration-200 ease-in-out">
                    Paciente (Z <i class="fa-solid fa-arrow-down"></i> A)
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                <thead>
                    <tr class="bg-gray-100 text-gray-700 uppercase text-lg leading-normal">
                        <th class="py-3 px-6 text-left">Paciente</th>
                        <th class="py-3 px-6 text-left">Tipo de Examen</th>
                        <th class="py-3 px-6 text-left">Fecha</th>
                        <th class="py-3 px-6 text-left">Médico Solicitante</th>
                        <th class="py-3 px-6 text-center">Resultados</th> 
                        <th class="py-3 px-6 text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody id="examinationsTableBody" class="text-gray-600 font-light">
                    <tr class="hover:bg-gray-50">
                        <td class="py-3 px-6 text-left whitespace-nowrap table-cell-text" colspan="6">
                            <p class="text-center text-gray-500 italic">No hay exámenes registrados aún. ¡Añade uno!</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="paginationControls" class="pagination-controls hidden">
            <button id="prevPageBtn" class="pagination-button">Anterior</button>
            <div id="pageNumbers" class="flex">
                </div>
            <button id="nextPageBtn" class="pagination-button">Siguiente</button>
        </div>
    </div>

    <div id="examinationModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeModalBtn">&times;</span>
            <h2 id="modalTitle" class="text-2xl font-bold text-center text-custom-highlight mb-6">Crear Nuevo Examen</h2>

            <form id="examinationForm" class="mt-5 space-y-5">
                <div class="accordion-item">
                    <button type="button" class="accordion-header active" data-target="patientContent">
                        1. Datos del Paciente
                        <i class="fa-solid fa-chevron-right accordion-icon"></i>
                    </button>
                    <div id="patientContent" class="accordion-content open">
                        <p class="text-gray-700 mb-4">Introduce el nombre del paciente:</p>
                        <div class="space-y-4">
                            <div>
                                <label for="nombrePaciente" class="block font-semibold text-gray-700">Nombre del Paciente</label>
                                <input type="text" id="nombrePaciente" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50" placeholder="Ej. Juan Pérez" pattern="[A-Za-zñÑáéíóúÁÉÍÓÚ\s-']+" title="Solo se permiten letras, espacios, guiones y apóstrofes." required>
                                <p id="pacienteError" class="text-red-600 text-base mt-1 hidden font-medium">El nombre del paciente solo puede contener letras, espacios, guiones y apóstrofes.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <button type="button" class="accordion-header" data-target="examDetailsContent">
                        2. Detalles del Examen
                        <i class="fa-solid fa-chevron-right accordion-icon"></i>
                    </button>
                    <div id="examDetailsContent" class="accordion-content">
                        <p class="text-gray-700 mb-4">Completa la información del examen:</p>
                        <div class="space-y-4">
                            <div>
                                <label for="tipoExamen" class="block font-semibold text-gray-700">Tipo de Examen</label>
                                <input type="text" id="tipoExamen" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50" placeholder="Ej. Análisis de sangre, Radiografía de tórax" required>
                            </div>
                            <div>
                                <label for="fechaExamen" class="block font-semibold text-gray-700">Fecha del Examen</label>
                                <input type="date" id="fechaExamen" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50" required>
                            </div>
                            <div>
                                <label for="resultadosExamen" class="block font-semibold text-gray-700">Resultados del Examen</label>
                                <textarea id="resultadosExamen" rows="6" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50" placeholder="Ej. Hemoglobina: 14.5 g/dL (normal), Radiografía: sin consolidaciones."></textarea>
                            </div>
                            <div>
                                <label for="notasExamen" class="block font-semibold text-gray-700">Notas Adicionales (Opcional)</label>
                                <textarea id="notasExamen" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <button type="button" class="accordion-header" data-target="doctorContent">
                        3. Información del Médico Solicitante
                        <i class="fa-solid fa-chevron-right accordion-icon"></i>
                    </button>
                    <div id="doctorContent" class="accordion-content">
                        <p class="text-gray-700 mb-4">Selecciona o introduce el médico que solicitó el examen:</p>
                        <div class="space-y-4">
                            <div>
                                <label for="medicoSolicitante" class="block font-semibold text-gray-700">Médico Solicitante</label>
                                <input type="text" id="medicoSolicitante" list="doctoresList" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50" required>
                                <datalist id="doctoresList"></datalist>
                                <p id="medicoError" class="text-red-600 text-base mt-1 hidden font-medium">El médico ingresado no se encuentra registrado.</p>
                            </div>
                            <div id="medicoEspecialidadDisplay" class="mt-2 text-gray-600 hidden">
                                Especialidad: <span id="medicoEspecialidadValue" class="font-medium"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between items-center gap-4 mt-6">
                    <button type="button" id="btnCancelarModal" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 text-lg">
                        Cancelar
                    </button>
                    <button type="submit" id="btnSaveUpdateExamination" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center text-lg">
                        <i class="fa-solid fa-floppy-disk mr-2"></i>
                        Guardar Examen
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeDetailModalBtn">&times;</span>
            <h3 class="text-xl font-bold text-custom-highlight mb-4">Resultados Detallados del Examen</h3>
            <p id="detailContentDisplay" class="text-gray-800 text-lg text-left whitespace-pre-wrap"></p>
            <p id="detailPatientName" class="text-gray-600 text-base mt-3 italic"></p>
        </div>
    </div>


    <script>
        // --- Datos Simulados de Doctores (Mismos que en Diagnósticos) ---
        const doctoresRegistrados = [
            { nombre: "Dr. Juan Pérez García", especialidad: "Cardiología" },
            { nombre: "Dra. Ana López Martínez", especialidad: "Pediatría" },
            { nombre: "Dr. Carlos Sánchez Ruiz", especialidad: "Medicina General" },
            { nombre: "Dra. María Fernández Díaz", especialidad: "Dermatología" },
            { nombre: "Dr. Luis Gómez Castro", especialidad: "Gastroenterología" },
            { nombre: "Dra. Laura Torres Vargas", especialidad: "Oftalmología" },
            { nombre: "Dr. Pedro Morales Castro", especialidad: "Neurología" },
            { nombre: "Dr. Javier Ruiz Vega", especialidad: "Urología" },
            { nombre: "Dra. Sofía Jiménez Bravo", especialidad: "Endocrinología" },
            { nombre: "Dr. Ricardo Núñez Palma", especialidad: "Ortopedia" },
            { nombre: "Dra. Elena Castro Soto", especialidad: "Psiquiatría" },
            { nombre: "Dr. Miguel Ángel Mora", especialidad: "Otorrinolaringología" },
            { nombre: "Dra. Isabel Vidal León", especialidad: "Ginecología" },
            { nombre: "Dr. Fernando Cano Gil", especialidad: "Oncología" }
        ];
        
        // --- Datos de Exámenes de Ejemplo ---
        let examinations = [
            { paciente: "Alicia Torres", tipoExamen: "Análisis de Sangre Completo", fecha: "2025-06-14", medicoSolicitante: "Dr. Carlos Sánchez Ruiz", especialidadMedico: "Medicina General", resultados: "Hemoglobina: 14.5 g/dL (Normal). Glucosa en ayunas: 90 mg/dL (Normal). Colesterol Total: 180 mg/dL (Normal).", notas: "Resultados generales dentro de los límites normales." },
            { paciente: "Benito Juárez", tipoExamen: "Radiografía de Tórax", fecha: "2025-06-12", medicoSolicitante: "Dr. Juan Pérez García", especialidadMedico: "Cardiología", resultados: "Sin evidencia de infiltrados, consolidaciones o efusiones. Silueta cardíaca de tamaño normal. Campos pulmonares claros.", notas: "Examen de seguimiento. No se observan cambios significativos desde el examen anterior." },
            { paciente: "Carla Mora", tipoExamen: "Urocultivo", fecha: "2025-06-10", medicoSolicitante: "Dr. Javier Ruiz Vega", especialidadMedico: "Urología", resultados: "Crecimiento de Escherichia coli > 10^5 UFC/mL. Sensible a Ciprofloxacino y Nitrofurantoína.", notas: "Diagnóstico de ITU. Se inició tratamiento antibiótico." },
            { paciente: "David Vargas", tipoExamen: "Electrocardiograma (ECG)", fecha: "2025-06-18", medicoSolicitante: "Dr. Juan Pérez García", especialidadMedico: "Cardiología", resultados: "Ritmo sinusal regular, frecuencia cardíaca 70 lpm. Eje normal. No se observan isquemias o arritmias significativas.", notas: "ECG de rutina preoperatorio." },
            { paciente: "Elena Soto", tipoExamen: "Cultivo Faringeo", fecha: "2025-06-15", medicoSolicitante: "Dra. Ana López Martínez", especialidadMedico: "Pediatría", resultados: "Negativo para Streptococcus pyogenes.", notas: "Descarta faringitis estreptocócica. Síntomas virales." },
            { paciente: "Felipe Naranjo", tipoExamen: "Resonancia Magnética Lumbar", fecha: "2025-06-16", medicoSolicitante: "Dr. Pedro Morales Castro", especialidadMedico: "Neurología", resultados: "Protrusión discal L4-L5 sin compresión radicular significativa.", notas: "Hallazgos consistentes con lumbalgia crónica." },
            { paciente: "Gabriela Pantoja", tipoExamen: "Prueba de Función Pulmonar (Espirometría)", fecha: "2025-06-17", medicoSolicitante: "Dr. Carlos Sánchez Ruiz", especialidadMedico: "Medicina General", resultados: "FEV1/FVC = 75% (Normal). FEV1 = 90% del predicho.", notas: "Resultados normales, descarta enfermedad obstructiva." },
            { paciente: "Héctor Solís", tipoExamen: "Perfil Tiroideo (TSH, T3, T4)", fecha: "2025-06-14", medicoSolicitante: "Dra. Sofía Jiménez Bravo", especialidadMedico: "Endocrinología", resultados: "TSH: 6.2 mUI/L (Elevada), T3 libre: normal, T4 libre: normal.", notas: "Consistente con hipotiroidismo subclínico." },
            { paciente: "Isabel Rivas", tipoExamen: "Radiografía de Tobillo", fecha: "2025-06-11", medicoSolicitante: "Dr. Ricardo Núñez Palma", especialidadMedico: "Ortopedia", resultados: "Sin evidencia de fracturas. Edema de tejidos blandos.", notas: "Confirma esguince, descarta fractura." },
            { paciente: "José Alarcón", tipoExamen: "Copia de Seguridad de Salud Mental", fecha: "2025-06-08", medicoSolicitante: "Dra. Elena Castro Soto", especialidadMedico: "Psiquiatría", resultados: "No aplica (sesión de terapia).", notas: "Sesión inicial de terapia." }
        ];

        // --- Paginación Variables ---
        const ITEMS_PER_PAGE = 7; 
        let currentPage = 1;

        // --- Elementos del DOM ---
        const examinationModal = document.getElementById('examinationModal');
        const openModalBtn = document.getElementById('openModalBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const btnCancelarModal = document.getElementById('btnCancelarModal');
        const examinationForm = document.getElementById('examinationForm');
        const modalTitle = document.getElementById('modalTitle');
        const btnSaveUpdateExamination = document.getElementById('btnSaveUpdateExamination');

        // Formulario campos
        const medicoSolicitanteInput = document.getElementById('medicoSolicitante');
        const doctoresList = document.getElementById('doctoresList');
        const medicoError = document.getElementById('medicoError');
        const medicoEspecialidadDisplay = document.getElementById('medicoEspecialidadDisplay');
        const medicoEspecialidadValue = document.getElementById('medicoEspecialidadValue');

        const pacienteInput = document.getElementById('nombrePaciente');
        const pacienteError = document.getElementById('pacienteError');
        const tipoExamenInput = document.getElementById('tipoExamen');
        const fechaExamenInput = document.getElementById('fechaExamen');
        const resultadosExamenInput = document.getElementById('resultadosExamen');
        const notasExamenInput = document.getElementById('notasExamen');
        const examinationsTableBody = document.getElementById('examinationsTableBody');

        // Filtros y Ordenamiento
        const searchInput = document.getElementById('searchInput');
        const filterDateInput = document.getElementById('filterDateInput');
        const sortDateAscBtn = document.getElementById('sortDateAscBtn');
        const sortDateDescBtn = document.getElementById('sortDateDescBtn');
        const sortPatientAscBtn = document.getElementById('sortPatientAscBtn');
        const sortPatientDescBtn = document.getElementById('sortPatientDescBtn');

        // Paginación DOM
        const paginationControls = document.getElementById('paginationControls');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const pageNumbersContainer = document.getElementById('pageNumbers');

        // Modal de Detalles (resultados)
        const detailModal = document.getElementById('detailModal');
        const closeDetailModalBtn = document.getElementById('closeDetailModalBtn');
        const detailContentDisplay = document.getElementById('detailContentDisplay');
        const detailPatientName = document.getElementById('detailPatientName');


        let currentEditIndex = -1; // -1 para nuevo, cualquier otro número para edición

        // --- Funciones del Acordeón ---
        const accordionHeaders = document.querySelectorAll('.accordion-header');

        function toggleAccordion(header) {
            const content = document.getElementById(header.dataset.target);
            const icon = header.querySelector('.accordion-icon');

            if (content.classList.contains('open')) {
                content.classList.remove('open');
                header.classList.remove('active');
            } else {
                accordionHeaders.forEach(h => {
                    const c = document.getElementById(h.dataset.target);
                    const i = h.querySelector('.accordion-icon');
                    if (h !== header && c.classList.contains('open')) {
                        c.classList.remove('open');
                        h.classList.remove('active');
                        i.style.transform = 'rotate(0deg)';
                    }
                });
                content.classList.add('open');
                header.classList.add('active');
            }
        }

        accordionHeaders.forEach(header => {
            header.addEventListener('click', () => toggleAccordion(header));
        });

        // --- Funciones del Modal principal (Crear/Editar) ---
        function openModal(isEditMode = false, examinationData = null, index = -1) {
            examinationModal.style.display = 'flex';
            resetFormAndDate(); 

            const firstHeader = document.querySelector('.accordion-item .accordion-header');
            const firstContent = document.getElementById(firstHeader.dataset.target);
            accordionHeaders.forEach(h => { 
                document.getElementById(h.dataset.target).classList.remove('open');
                h.classList.remove('active');
                h.querySelector('.accordion-icon').style.transform = 'rotate(0deg)';
            });
            firstContent.classList.add('open'); 
            firstHeader.classList.add('active');
            firstHeader.querySelector('.accordion-icon').style.transform = 'rotate(90deg)';
            
            if (isEditMode && examinationData) {
                modalTitle.textContent = 'Editar Examen';
                btnSaveUpdateExamination.innerHTML = '<i class="fa-solid fa-save mr-2"></i> Actualizar Examen';
                currentEditIndex = index;
                
                pacienteInput.value = examinationData.paciente;
                tipoExamenInput.value = examinationData.tipoExamen;
                fechaExamenInput.value = examinationData.fecha; 
                resultadosExamenInput.value = examinationData.resultados;
                notasExamenInput.value = examinationData.notas;
                medicoSolicitanteInput.value = examinationData.medicoSolicitante;

                const selectedDoctor = doctoresRegistrados.find(d => d.nombre === examinationData.medicoSolicitante);
                if (selectedDoctor) {
                    medicoEspecialidadValue.textContent = selectedDoctor.especialidad;
                    medicoEspecialidadDisplay.classList.remove('hidden');
                } else {
                    medicoEspecialidadDisplay.classList.add('hidden');
                }

            } else {
                modalTitle.textContent = 'Crear Nuevo Examen';
                btnSaveUpdateExamination.innerHTML = '<i class="fa-solid fa-floppy-disk mr-2"></i> Guardar Examen';
                currentEditIndex = -1; 
            }
        }

        function closeModal() {
            examinationModal.style.display = 'none';
            resetFormAndDate();
            currentEditIndex = -1; 
            medicoEspecialidadDisplay.classList.add('hidden'); 
        }

        openModalBtn.addEventListener('click', () => openModal(false));
        closeModalBtn.addEventListener('click', closeModal);
        btnCancelarModal.addEventListener('click', closeModal);

        window.addEventListener('click', (event) => {
            if (event.target == examinationModal) {
                closeModal();
            }
        });

        function resetFormAndDate() {
            examinationForm.reset();
            pacienteError.classList.add('hidden');
            medicoError.classList.add('hidden');
            medicoEspecialidadDisplay.classList.add('hidden'); 

            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`; 
            fechaExamenInput.value = formattedDate;
        }

        // --- Función para limpiar dobles espacios y trim ---
        function cleanAndTrimSpaces(inputElement) {
            inputElement.value = inputElement.value.replace(/\s{2,}/g, ' ').trim();
        }

        // --- Asignar la función cleanAndTrimSpaces solo al evento 'blur' ---
        pacienteInput.addEventListener('blur', () => cleanAndTrimSpaces(pacienteInput));
        tipoExamenInput.addEventListener('blur', () => cleanAndTrimSpaces(tipoExamenInput));
        resultadosExamenInput.addEventListener('blur', () => cleanAndTrimSpaces(resultadosExamenInput));
        notasExamenInput.addEventListener('blur', () => cleanAndTrimSpaces(notasExamenInput));

        // --- Cargar opciones en el datalist de doctores y mostrar especialidad ---
        doctoresRegistrados.forEach(doctor => {
            const option = document.createElement('option');
            option.value = doctor.nombre;
            option.setAttribute('data-especialidad', doctor.especialidad); 
            doctoresList.appendChild(option);
        });

        medicoSolicitanteInput.addEventListener('input', () => {
            validarMedico();
            const enteredMedico = medicoSolicitanteInput.value;
            const selectedDoctor = doctoresRegistrados.find(d => d.nombre === enteredMedico);
            if (selectedDoctor) {
                medicoEspecialidadValue.textContent = selectedDoctor.especialidad;
                medicoEspecialidadDisplay.classList.remove('hidden');
            } else {
                medicoEspecialidadValue.textContent = '';
                medicoEspecialidadDisplay.classList.add('hidden');
            }
        });
        medicoSolicitanteInput.addEventListener('blur', validarMedico);

        // --- Validaciones ---
        function validarMedico() {
            const nombreMedico = medicoSolicitanteInput.value.trim();
            if (nombreMedico === "") {
                medicoError.classList.add('hidden');
                return true;
            }
            if (doctoresRegistrados.some(d => d.nombre === nombreMedico)) {
                medicoError.classList.add('hidden');
                return true;
            } else {
                medicoError.classList.remove('hidden');
                return false;
            }
        }

        pacienteInput.addEventListener('input', validarPaciente);
        pacienteInput.addEventListener('blur', validarPaciente);
        function validarPaciente() {
            const nombre = pacienteInput.value.trim();
            const regex = /^[A-Za-zñÑáéíóúÁÉÍÓÚ\s-']+$/;
            if (nombre === "") {
                pacienteError.classList.add('hidden');
                return true;
            }
            if (regex.test(nombre)) {
                pacienteError.classList.add('hidden');
                return true;
            } else {
                pacienteError.classList.remove('hidden');
                return false;
            }
        }

        // --- Función para formatear la fecha a "dd/mm/aa" ---
        function formatFechaToDDMMYY(dateString) {
            const [year, month, day] = dateString.split('-');
            const shortYear = year.slice(-2); 
            return `${day}/${month}/${shortYear}`;
        }

        // --- Funciones CRUD y Paginación ---

        function renderExaminationsTable() {
            examinationsTableBody.innerHTML = '';
            let filteredAndSortedExaminations = [...examinations]; 

            // Aplicar Filtro de Búsqueda por Texto
            const searchTerm = searchInput.value.toLowerCase().trim();
            if (searchTerm) {
                filteredAndSortedExaminations = filteredAndSortedExaminations.filter(exam => 
                    exam.paciente.toLowerCase().includes(searchTerm) ||
                    exam.tipoExamen.toLowerCase().includes(searchTerm) ||
                    exam.medicoSolicitante.toLowerCase().includes(searchTerm) ||
                    exam.especialidadMedico.toLowerCase().includes(searchTerm) ||
                    exam.resultados.toLowerCase().includes(searchTerm) ||
                    exam.notas.toLowerCase().includes(searchTerm)
                );
            }

            // Aplicar Filtro por Fecha (coincidencia EXACTA)
            const filterDate = filterDateInput.value;
            if (filterDate) {
                filteredAndSortedExaminations = filteredAndSortedExaminations.filter(exam => exam.fecha === filterDate);
            }

            // Paginación: Calcular el rango de exámenes a mostrar
            const totalPages = Math.ceil(filteredAndSortedExaminations.length / ITEMS_PER_PAGE);
            
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            } else if (totalPages === 0) {
                currentPage = 1;
            }

            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const examinationsToDisplay = filteredAndSortedExaminations.slice(startIndex, endIndex);

            if (examinationsToDisplay.length === 0) {
                const noDataRow = document.createElement('tr');
                noDataRow.className = 'hover:bg-gray-50';
                noDataRow.innerHTML = `
                    <td class="py-3 px-6 text-left whitespace-nowrap table-cell-text" colspan="6">
                        <p class="text-center text-gray-500 italic">No hay exámenes que coincidan con los filtros o en esta página.</p>
                    </td>
                `;
                examinationsTableBody.appendChild(noDataRow);
            } else {
                examinationsToDisplay.forEach((exam) => {
                    // Buscar el índice original para edición/eliminación
                    const originalIndex = examinations.findIndex(e => 
                        e.paciente === exam.paciente && 
                        e.tipoExamen === exam.tipoExamen && 
                        e.fecha === exam.fecha &&
                        e.medicoSolicitante === exam.medicoSolicitante 
                    );

                    const formattedDate = formatFechaToDDMMYY(exam.fecha); 

                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-3 px-6 text-left whitespace-nowrap table-cell-text">${exam.paciente}</td>
                        <td class="py-3 px-6 text-left table-cell-text">${exam.tipoExamen}</td>
                        <td class="py-3 px-6 text-left table-cell-text">${formattedDate}</td> 
                        <td class="py-3 px-6 text-left table-cell-text">${exam.medicoSolicitante} (${exam.especialidadMedico || 'N/A'})</td>
                        <td class="py-3 px-6 text-center">
                            <button onclick="showDetails('${encodeURIComponent(exam.resultados)}', '${encodeURIComponent(exam.paciente)} - ${encodeURIComponent(exam.tipoExamen)}')" 
                                    class="transform hover:scale-110 transition duration-200 ease-in-out btn-action-icon" 
                                    title="Ver Resultados">
                                <i class="fa-solid fa-file-alt text-lg"></i>
                            </button>
                        </td>
                        <td class="py-3 px-6 text-center">
                            <div class="flex item-center justify-center">
                                <button onclick="editExamination(${originalIndex})" class="w-auto mx-2 transform hover:scale-110 btn-action-icon">
                                    <i class="fa-solid fa-edit text-lg"></i>
                                </button>
                                <button onclick="deleteExamination(${originalIndex})" class="w-auto mx-2 transform text-red-500 hover:text-red-700 hover:scale-110">
                                    <i class="fa-solid fa-trash-alt text-lg"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    examinationsTableBody.appendChild(row);
                });
            }
            updatePaginationControls(totalPages);
        }

        // --- Funciones de Edición y Eliminación ---
        window.editExamination = function(index) {
            const examinationToEdit = examinations[index];
            if (examinationToEdit) {
                openModal(true, examinationToEdit, index);
            }
        }

        window.deleteExamination = function(index) {
            if (confirm(`¿Estás seguro de que quieres eliminar el examen de "${examinations[index].paciente}" (${examinations[index].tipoExamen})?`)) {
                examinations.splice(index, 1);
                renderExaminationsTable();
                alert('Examen eliminado con éxito.');
            }
        }

        // --- Manejo del envío del formulario (Crear/Actualizar) ---
        examinationForm.addEventListener('submit', function(event) {
            event.preventDefault();

            cleanAndTrimSpaces(pacienteInput);
            cleanAndTrimSpaces(tipoExamenInput);
            cleanAndTrimSpaces(resultadosExamenInput);
            cleanAndTrimSpaces(notasExamenInput);

            const nombrePaciente = pacienteInput.value.trim();
            const tipoExamen = tipoExamenInput.value.trim();
            const fecha = fechaExamenInput.value; 
            const resultados = resultadosExamenInput.value.trim();
            const notas = notasExamenInput.value.trim();
            const medicoSolicitante = medicoSolicitanteInput.value.trim();

            const pacienteEsValido = validarPaciente();
            const medicoEsValido = validarMedico();

            if (!pacienteEsValido) {
                alert('Error: El nombre del paciente solo puede contener letras, espacios, guiones y apóstrofes. Por favor, corrija los datos y revise la sección "Datos del Paciente".');
                return;
            }
            if (!medicoEsValido) {
                alert('Error: El médico ingresado no se encuentra registrado. Por favor, seleccione uno de la lista o corrija el nombre y revise la sección "Información del Médico Solicitante".');
                return;
            }

            // Validar campos obligatorios
            if (!(nombrePaciente && tipoExamen && fecha && medicoSolicitante)) {
                 alert('Por favor, completa todos los campos obligatorios en todas las secciones: Paciente, Tipo de Examen, Fecha y Médico Solicitante.');
                 return;
            }

            const selectedDoctor = doctoresRegistrados.find(d => d.nombre === medicoSolicitante);
            const especialidadMedico = selectedDoctor ? selectedDoctor.especialidad : 'Desconocida';

            const newExaminationData = {
                paciente: nombrePaciente,
                tipoExamen: tipoExamen,
                fecha: fecha,
                resultados: resultados,
                notas: notas,
                medicoSolicitante: medicoSolicitante,
                especialidadMedico: especialidadMedico
            };

            if (currentEditIndex !== -1) {
                examinations[currentEditIndex] = newExaminationData;
                alert('Examen actualizado con éxito.');
            } else {
                examinations.push(newExaminationData);
                alert('Examen guardado con éxito.');
            }
            
            renderExaminationsTable();
            closeModal();
        });

        // --- Eventos de Búsqueda y Filtro ---
        searchInput.addEventListener('input', () => {
            currentPage = 1; 
            renderExaminationsTable();
        });
        filterDateInput.addEventListener('change', () => {
            currentPage = 1; 
            renderExaminationsTable();
        });

        // --- Eventos de Ordenamiento ---
        sortDateAscBtn.addEventListener('click', () => {
            examinations.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
            currentPage = 1; 
            renderExaminationsTable();
        });
        sortDateDescBtn.addEventListener('click', () => {
            examinations.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            currentPage = 1; 
            renderExaminationsTable();
        });
        sortPatientAscBtn.addEventListener('click', () => {
            examinations.sort((a, b) => a.paciente.localeCompare(b.paciente, 'es', { sensitivity: 'base' })); 
            currentPage = 1; 
            renderExaminationsTable();
        });
        sortPatientDescBtn.addEventListener('click', () => {
            examinations.sort((a, b) => b.paciente.localeCompare(a.paciente, 'es', { sensitivity: 'base' }));
            currentPage = 1; 
            renderExaminationsTable();
        });

        // --- Funciones de Paginación ---
        function updatePaginationControls(totalPages) {
            pageNumbersContainer.innerHTML = ''; 

            if (totalPages <= 1) {
                paginationControls.classList.add('hidden');
                return;
            } else {
                paginationControls.classList.remove('hidden');
            }

            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;

            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.className = 'pagination-button';
                if (i === currentPage) {
                    pageButton.classList.add('active-page');
                }
                pageButton.addEventListener('click', () => {
                    currentPage = i;
                    renderExaminationsTable();
                });
                pageNumbersContainer.appendChild(pageButton);
            }
        }

        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderExaminationsTable();
            }
        });

        nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(examinations.length / ITEMS_PER_PAGE);
            if (currentPage < totalPages) {
                currentPage++;
                renderExaminationsTable();
            }
        });

        // --- Funciones para el Modal de Detalles de Resultados ---
        window.showDetails = function(encodedDetails, encodedPatientExam) {
            const detailText = decodeURIComponent(encodedDetails);
            const patientExam = decodeURIComponent(encodedPatientExam);
            detailContentDisplay.textContent = detailText;
            detailPatientName.textContent = `Resultados para: ${patientExam}`;
            detailModal.style.display = 'flex';
        }

        closeDetailModalBtn.addEventListener('click', () => {
            detailModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target == detailModal) {
                detailModal.style.display = 'none';
            }
        });

        // --- Inicialización ---
        document.addEventListener('DOMContentLoaded', () => {
            renderExaminationsTable();
        });
    </script>

</body>
</html>